<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MathArt - Full Immersive Studio</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Inter', sans-serif; overflow: hidden; display: flex; }
        
        /* Sidebar */
        #sidebar { 
            width: 300px; background: rgba(5, 5, 5, 0.98); border-right: 1px solid #333; 
            padding: 25px; z-index: 20; display: flex; flex-direction: column; gap: 20px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Top Bar */
        .ui-top { 
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%); 
            width: 70%; z-index: 10; transition: all 0.5s; 
        }
        
        input#eqInput { 
            width: 100%; background: rgba(15, 15, 15, 0.95); border: 1px solid #444; color: #00ffcc; 
            padding: 18px; font-size: 1rem; outline: none; border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6); font-family: 'Courier New', monospace;
        }

        /* HUD Toggle Logic */
        body.hud-hidden #sidebar { transform: translateX(-100%); margin-left: -300px; opacity: 0; }
        body.hud-hidden .ui-top { transform: translate(-50%, -120px); opacity: 0; }
        body.hud-hidden .toggle-btn { opacity: 0; pointer-events: none; }
        body.hud-hidden.show-trigger .toggle-btn { opacity: 1; pointer-events: auto; }

        .color-row { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; font-size: 0.8rem; }
        input[type="color"] { border: none; width: 40px; height: 30px; background: none; cursor: pointer; }

        .toggle-btn {
            position: fixed; bottom: 30px; right: 30px; z-index: 100;
            background: #fff; color: #000; border: none;
            padding: 12px 24px; cursor: pointer; font-weight: 800; border-radius: 50px;
            transition: opacity 0.3s; font-size: 0.7rem; letter-spacing: 1px;
        }
        
        .preset-item { 
            background: #111; border: 1px solid #222; padding: 10px; border-radius: 8px;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
        }
        .preset-item label { cursor: pointer; flex-grow: 1; font-size: 0.8rem; }
        
        canvas { display: block; width: 100vw; height: 100vh; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2 style="font-size: 0.7rem; letter-spacing: 3px; color: #666;">PALETTE</h2>
        <div class="color-group">
            <div class="color-row">CORE <input type="color" id="col1" value="#000000"></div>
            <div class="color-row">MID <input type="color" id="col2" value="#ff0055"></div>
            <div class="color-row">GLOW <input type="color" id="col3" value="#00ffcc"></div>
        </div>

        <h2 style="font-size: 0.7rem; letter-spacing: 3px; color: #666; margin-top: 10px;">PRESETS</h2>
        <div id="presetList"></div>
        
        <button onclick="clearAll()" style="background:none; border: 1px solid #444; color: #888; padding: 5px; cursor: pointer; font-size: 0.6rem; border-radius: 4px;">CLEAR ALL</button>
    </div>

    <div style="flex-grow:1; position:relative;">
        <div class="ui-top">
            <input type="text" id="eqInput" value="cos(log(length(uv-0.5))*1.618 + atan(y-res.y/2.0, x-res.x/2.0) - t)" spellcheck="false">
        </div>
        <canvas id="glCanvas"></canvas>
    </div>

    <button class="toggle-btn" onclick="toggleHUD()">HIDE HUD</button>

<script type="module">
    const canvas = document.getElementById('glCanvas');
    const gl = canvas.getContext('webgl');
    const input = document.getElementById('eqInput');
    const presetList = document.getElementById('presetList');

    let customBase = input.value; // Remembers what you typed
    let idle;

    // --- HUD LOGIC ---
    window.toggleHUD = () => document.body.classList.toggle('hud-hidden');
    window.addEventListener('mousemove', () => {
        if (document.body.classList.contains('hud-hidden')) {
            document.body.classList.add('show-trigger');
            clearTimeout(idle);
            idle = setTimeout(() => document.body.classList.remove('show-trigger'), 2000);
        }
    });

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            toggleHUD();
        }
    });

    window.clearAll = () => {
        customBase = "";
        input.value = "";
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateProgram();
    };

    // --- NON-DESTRUCTIVE PRESETS ---
    const presets = [
        { name: "Fibonacci Spiral", eq: "cos(log(length(uv-0.5))*1.618 + atan(y-res.y/2.0, x-res.x/2.0) - t)" },
        { name: "Hyperspace", eq: "sin(1.0/length(uv-0.5) + t*3.0)" },
        { name: "Neon Vortex", eq: "sin(atan(y-res.y/2.0, x-res.x/2.0)*5.0 + length(uv-0.5)*15.0 - t*4.0)" },
        { name: "Digital Noise", eq: "fract(sin(x*y)*437.5) * sin(t)" }
    ];

    presets.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'preset-item';
        div.innerHTML = `<input type="checkbox" id="p${i}" value="${p.eq}"> <label for="p${i}">${p.name}</label>`;
        presetList.appendChild(div);
        
        div.querySelector('input').addEventListener('change', () => {
            const active = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            // Combine manual base with checked presets
            let finalEq = customBase;
            if (active.length > 0) {
                finalEq = (customBase.trim() ? customBase + " + " : "") + active.join(" + ");
            }
            input.value = finalEq;
            updateProgram();
        });
    });

    // Capture manual edits so they aren't lost when checking/unchecking
    input.addEventListener('input', () => {
        const activeValues = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        let tempValue = input.value;
        // Basic attempt to strip out preset strings to find the "new" manual base
        activeValues.forEach(v => { tempValue = tempValue.replace(v, "").replace(" +  + ", " + "); });
        customBase = tempValue.trim().replace(/^\+|\+$/g, '');
        updateProgram();
    });

    // --- GPU ENGINE ---
    const vs = `attribute vec2 pos; void main() { gl_Position = vec4(pos, 0, 1); }`;
    function createFS(userEq) {
        return `precision highp float; 
            uniform float t; uniform vec2 res;
            uniform vec3 c1, c2, c3;
            void main() {
                vec2 uv = gl_FragCoord.xy / res;
                float x = gl_FragCoord.x; float y = gl_FragCoord.y;
                float val = clamp(abs(${userEq || "0.0"}), 0.0, 1.0);
                vec3 col = (val < 0.5) ? mix(c1, c2, val*2.0) : mix(c2, c3, (val-0.5)*2.0);
                gl_FragColor = vec4(col, 1.0);
            }`;
    }

    let program, tLoc, resLoc, c1Loc, c2Loc, c3Loc;
    const hex = h => [parseInt(h.slice(1,3),16)/255, parseInt(h.slice(3,5),16)/255, parseInt(h.slice(5,7),16)/255];

    function updateProgram() {
        try {
            const vS = gl.createShader(gl.VERTEX_SHADER); gl.shaderSource(vS, vs); gl.compileShader(vS);
            const fS = gl.createShader(gl.FRAGMENT_SHADER); gl.shaderSource(fS, createFS(input.value)); gl.compileShader(fS);
            program = gl.createProgram(); gl.attachShader(program, vS); gl.attachShader(program, fS); gl.linkProgram(program);
            gl.useProgram(program);
            tLoc = gl.getUniformLocation(program, "t"); resLoc = gl.getUniformLocation(program, "res");
            c1Loc = gl.getUniformLocation(program, "c1"); c2Loc = gl.getUniformLocation(program, "c2"); c3Loc = gl.getUniformLocation(program, "c3");
        } catch (e) { console.warn("Math Syntax Error"); }
    }

    const buffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, -1,1, 1,-1, 1,1]), gl.STATIC_DRAW);

    function render(time) {
        time *= 0.001;
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        gl.viewport(0, 0, canvas.width, canvas.height);
        const posAttr = gl.getAttribLocation(program, "pos");
        gl.enableVertexAttribArray(posAttr);
        gl.vertexAttribPointer(posAttr, 2, gl.FLOAT, false, 0, 0);
        gl.uniform3fv(c1Loc, hex(document.getElementById('col1').value));
        gl.uniform3fv(c2Loc, hex(document.getElementById('col2').value));
        gl.uniform3fv(c3Loc, hex(document.getElementById('col3').value));
        gl.uniform1f(tLoc, time); gl.uniform2f(resLoc, canvas.width, canvas.height);
        gl.drawArrays(gl.TRIANGLES, 0, 6);
        requestAnimationFrame(render);
    }

    updateProgram();
    requestAnimationFrame(render);
</script>
</body>
</html>